<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>H&O Botic - Sistema Completo</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#f0f8ff;}
#login-screen{height:100vh;display:flex;justify-content:center;align-items:center;background:#e0f7ff;}
.card-login{padding:30px;background:#fff;border-radius:15px;box-shadow:0 8px 24px rgba(0,0,0,0.1);width:380px;text-align:center;}
#system{display:none;}
.sidebar{width:230px;height:100vh;background:#00bfff;color:#fff;position:fixed;top:0;left:0;overflow:auto;display:none;padding-top:10px;}
.sidebar .brand{text-align:center;padding:20px;border-bottom:1px solid rgba(255,255,255,0.3);}
.sidebar .brand img{width:100px;}
.sidebar a{display:block;padding:12px 20px;color:#fff;text-decoration:none;cursor:pointer;border-radius:8px;margin:5px;}
.sidebar a:hover,.sidebar a.active{background:#b2ebf2;color:#000;}
.topbar{height:60px;background:#fff;display:flex;align-items:center;padding:0 20px;box-shadow:0 2px 6px rgba(0,0,0,0.08);margin-left:0;display:none;}
#main{margin-left:230px;padding:20px;transition: margin-left 0.3s;}
.page{display:none;}
.card-ghost{border-radius:12px;padding:18px;background:#e6f7ff;box-shadow:0 6px 18px rgba(16,24,40,0.04);margin-bottom:15px;}
.autocomplete-list{position:absolute;z-index:1200;background:#fff;border:1px solid #ddd;border-radius:6px;max-height:200px;overflow:auto;width:100%;}
.autocomplete-item{padding:8px 10px;cursor:pointer;}
.autocomplete-item:hover{background:#d0f0ff;}
.btn-pastel{background:#b2ebf2;color:#000;}
.btn-pastel:hover{background:#81ecec;color:#000;}
.form-section{padding:15px;border:1px solid #ddd;border-radius:8px;background:#f0fcff;margin-bottom:15px;}
td input{width:100%;}
.position-relative{position:relative;}
.autocomplete-container{position:relative;}
/* BANNER DESCARGA APP */
#downloadBanner{
  position:fixed; bottom:10px; right:10px; background:#00bfff; color:#fff; padding:15px 20px; border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,0.2); z-index:9999; display:none; align-items:center; gap:10px;
}
#downloadBanner a{color:#000; font-weight:bold; text-decoration:none;}
#downloadBanner button{border:none; background:transparent; color:#fff; font-weight:bold; cursor:pointer;}
</style>
</head>
<body>

<!-- BANNER DESCARGA APP -->
<div id="downloadBanner">
  <span>üì± Descarga nuestra App</span>
  <a href="H_OBotic.apk" download>Descargar</a>
  <button onclick="this.parentElement.style.display='none'">‚úñ</button>
</div>

<!-- LOGIN -->
<div id="login-screen">
  <div class="card-login">
    <img src="https://i.imgur.com/y2DPHWS.png" style="width:140px;margin-bottom:10px;">
    <h4>Iniciar sesi√≥n</h4>
    <input id="user" class="form-control mb-2" placeholder="Usuario">
    <div class="d-flex mb-2">
      <input id="pass" type="password" class="form-control" placeholder="Contrase√±a">
      <button id="togglePass" class="btn btn-outline-secondary ms-1">üëÅÔ∏è</button>
    </div>
    <button id="btnLogin" class="btn btn-pastel w-100 mb-2">Ingresar</button>
    <p id="error" class="text-danger"></p>
  </div>
</div>

<!-- SISTEMA -->
<div id="system">
  <div class="sidebar">
    <div class="brand">
      <img src="https://i.imgur.com/y2DPHWS.png">
      <div style="margin-top:6px;font-weight:700;">H&O BOTIC</div>
    </div>
    <a data-page="inicio" class="active">üè† Inicio</a>
    <a data-page="ventas">üí≤ Ventas</a>
    <a data-page="clientes">üë• Clientes</a>
    <a data-page="productos">üíä Productos</a>
    <a data-page="reportes">üìä Reportes</a>
    <a data-page="config">‚öô Configuraci√≥n</a>
    <a id="link-logout" class="bg-danger text-center mt-3">Salir</a>
  </div>

  <div class="topbar">
    <div style="font-weight:700;">Panel de administraci√≥n</div>
    <div style="margin-left:auto;" id="userInfo">Usuario: ‚Äî</div>
  </div>

  <div id="main">
    <!-- INICIO -->
    <section id="inicio" class="page">
      <h3>Resumen</h3>
      <div class="row mb-3">
        <div class="col-md-4"><div class="card-ghost text-center"><h2 id="countProd">0</h2> Productos</div></div>
        <div class="col-md-4"><div class="card-ghost text-center"><h2 id="countClients">0</h2> Clientes</div></div>
        <div class="col-md-4"><div class="card-ghost text-center"><h2 id="countStock">0</h2> Stock total</div></div>
      </div>
      <div class="card-ghost"><canvas id="summaryChart" height="150"></canvas></div>
    </section>

    <!-- VENTAS -->
    <section id="ventas" class="page">
      <h3>Ventas</h3>
      <div class="card-ghost mb-3 position-relative autocomplete-container">
        <div class="row g-2 mb-2">
          <div class="col-md-4 position-relative">
            <input id="searchSale" class="form-control" placeholder="Buscar producto...">
            <div id="autocompleteProduct" class="autocomplete-list"></div>
          </div>
          <div class="col-md-2"><input type="number" id="qtySale" class="form-control" value="1" min="1"></div>
          <div class="col-md-4 position-relative">
            <input id="clientSale" class="form-control" placeholder="Nombre del Cliente">
            <div id="autocompleteClient" class="autocomplete-list"></div>
          </div>
          <div class="col-md-2"><button id="btnAddSale" class="btn btn-pastel w-100">A√±adir</button></div>
        </div>
        <h5>Carrito</h5>
        <table class="table table-bordered">
          <thead><tr><th>Producto</th><th>Cant</th><th>Precio</th><th>Subtotal</th><th>Cliente</th><th>Acci√≥n</th></tr></thead>
          <tbody id="cartTbody"></tbody>
        </table>
        <div class="text-end mb-2"><strong>Total: S/<span id="cartTotal">0.00</span></strong></div>
        <button id="completeSale" class="btn btn-success mb-2">Completar Venta</button>
        <h5>Reporte de Ventas</h5>
        <table class="table table-bordered">
          <thead><tr><th>Cliente</th><th>Producto</th><th>Cant</th><th>Total</th><th>Acci√≥n</th></tr></thead>
          <tbody id="salesReport"></tbody>
        </table>
        <div class="text-end"><strong>Total Vendido: S/<span id="totalSold">0.00</span></strong></div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section id="clientes" class="page">
      <h3>Clientes</h3>
      <div class="card-ghost form-section">
        <h5>A√±adir Cliente</h5>
        <div class="row g-2">
          <div class="col-md-2"><input type="text" id="newClientCode" class="form-control" placeholder="C√≥digo" readonly></div>
          <div class="col-md-4"><input type="text" id="newClientName" class="form-control" placeholder="Nombre"></div>
          <div class="col-md-2"><input type="text" id="newClientDoc" class="form-control" placeholder="Documento"></div>
          <div class="col-md-2"><input type="text" id="newClientPhone" class="form-control" placeholder="Tel√©fono"></div>
          <div class="col-md-2"><input type="text" id="newClientEmail" class="form-control" placeholder="Email"></div>
        </div>
        <button id="addClientBtn" class="btn btn-pastel mt-2">A√±adir Cliente</button>
      </div>
      <input id="searchClient" class="form-control mb-2" placeholder="Buscar cliente...">
      <table class="table table-bordered">
        <thead><tr><th>C√≥digo</th><th>Nombre</th><th>Documento</th><th>Tel√©fono</th><th>Email</th><th>Acciones</th></tr></thead>
        <tbody id="clientsTable"></tbody>
      </table>
    </section>

    <!-- PRODUCTOS -->
    <section id="productos" class="page">
      <h3>Productos</h3>
      <div class="card-ghost form-section">
        <h5>A√±adir Producto</h5>
        <div class="row g-2">
          <div class="col-md-2"><input type="text" id="newProductCode" class="form-control" placeholder="C√≥digo" readonly></div>
          <div class="col-md-4"><input type="text" id="newProductName" class="form-control" placeholder="Nombre"></div>
          <div class="col-md-2"><input type="number" id="newProductStock" class="form-control" placeholder="Stock"></div>
          <div class="col-md-2"><input type="number" id="newProductPrice" class="form-control" placeholder="Precio"></div>
          <div class="col-md-2"><button id="addProductBtn" class="btn btn-pastel w-100">A√±adir</button></div>
        </div>
      </div>
      <input id="searchProduct" class="form-control mb-2" placeholder="Buscar producto...">
      <table class="table table-bordered">
        <thead><tr><th>C√≥digo</th><th>Nombre</th><th>Stock</th><th>Precio</th><th>Acciones</th></tr></thead>
        <tbody id="productsTable"></tbody>
      </table>
    </section>

    <!-- REPORTES -->
    <section id="reportes" class="page">
      <h3>Reportes</h3>
      <div class="card-ghost mb-3">
        <button id="exportExcel" class="btn btn-pastel mb-2">Exportar Excel</button>
        <button id="exportPDF" class="btn btn-pastel mb-2">Exportar PDF</button>
      </div>
      <div class="card-ghost">
        <h5>Gr√°fico Ventas por Producto</h5>
        <canvas id="salesChart" height="150"></canvas>
      </div>
    </section>

    <!-- CONFIGURACI√ìN -->
    <section id="config" class="page">
      <h3>Configuraci√≥n</h3>
      <div class="card-ghost form-section">
        <h5>Editar Configuraci√≥n</h5>
        <label>Nombre de la Botica:</label>
        <input type="text" id="configName" class="form-control mb-2" placeholder="Nombre de la Botica">
        <label>Tel√©fono:</label>
        <input type="text" id="configPhone" class="form-control mb-2" placeholder="Tel√©fono">
        <label>Email:</label>
        <input type="text" id="configEmail" class="form-control mb-2" placeholder="Email">
        <button id="saveConfig" class="btn btn-pastel mt-2">Guardar Configuraci√≥n</button>
      </div>
    </section>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const LOGIN_USER='Keyla Nima';
  const LOGIN_PASS='olinda';
  const $=id=>document.getElementById(id);
  const sidebar=document.querySelector('.sidebar');
  const topbar=document.querySelector('.topbar');
  const links=document.querySelectorAll('.sidebar a[data-page]');

  let products=JSON.parse(localStorage.getItem('ho_products'))||[];
  let clients=JSON.parse(localStorage.getItem('ho_clients'))||[];
  let cart=JSON.parse(localStorage.getItem('ho_cart'))||[];
  let sales=JSON.parse(localStorage.getItem('ho_sales'))||[];

  function saveAll(){
    localStorage.setItem('ho_products',JSON.stringify(products));
    localStorage.setItem('ho_clients',JSON.stringify(clients));
    localStorage.setItem('ho_cart',JSON.stringify(cart));
    localStorage.setItem('ho_sales',JSON.stringify(sales));
  }

  // --- LOGIN ---
  function login(){
    const u=$('user').value.trim();
    const p=$('pass').value.trim();
    if(u.toLowerCase()===LOGIN_USER.toLowerCase() && p===LOGIN_PASS){
      $('login-screen').style.display='none';
      $('system').style.display='block';
      sidebar.style.display='block';
      topbar.style.display='flex';
      $('userInfo').textContent='Usuario: '+LOGIN_USER;
      renderAll();
      showPage('inicio');
    } else $('error').textContent='Usuario o contrase√±a incorrectos';
  }
  $('btnLogin').addEventListener('click',login);
  $('togglePass').addEventListener('click',()=>{$('pass').type=$('pass').type==='password'?'text':'password';});
  $('link-logout').addEventListener('click',()=>location.reload());
  links.forEach(el=>el.addEventListener('click',()=>showPage(el.dataset.page)));

  function showPage(id){
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    $(id).style.display='block';
    links.forEach(l=>l.classList.remove('active'));
    document.querySelector(`.sidebar a[data-page="${id}"]`).classList.add('active');
  }

  // Mostrar banner de descarga al cargar
  if(!localStorage.getItem('bannerDownloaded')){
    const banner = document.getElementById('downloadBanner');
    banner.style.display = 'flex';
  }
  document.querySelector('#downloadBanner a').addEventListener('click',()=>{
    localStorage.setItem('bannerDownloaded','true');
    document.getElementById('downloadBanner').style.display='none';
  });

  // ==================== Funciones de Render ====================
  function renderAll(){
    renderCounts();
    renderProducts();
    renderClients();
    renderCart();
    renderSalesReport();
    renderSalesChart();
  }

  function renderCounts(){
    $('countProd').textContent=products.length;
    $('countClients').textContent=clients.length;
    $('countStock').textContent=products.reduce((a,b)=>a+b.stock,0);
    renderChart();
  }

  function renderChart(){
    const ctx=document.getElementById('summaryChart').getContext('2d');
    if(window.summaryChart) window.summaryChart.destroy();
    window.summaryChart=new Chart(ctx,{
      type:'bar',
      data:{
        labels:products.map(p=>p.name),
        datasets:[{label:'Stock',data:products.map(p=>p.stock),backgroundColor:'#00bfff'}]
      },
      options:{responsive:true,plugins:{legend:{display:false}}}
    });
  }

  // ==================== Ventas Chart ====================
  function renderSalesChart(){
    const ctx=document.getElementById('salesChart').getContext('2d');
    const prodNames=[...new Set(sales.map(s=>s.name))];
    const totals=prodNames.map(name=>{
      return sales.filter(s=>s.name===name).reduce((a,b)=>a+b.qty,0);
    });
    if(window.salesChart) window.salesChart.destroy();
    window.salesChart=new Chart(ctx,{
      type:'pie',
      data:{labels:prodNames,datasets:[{label:'Ventas',data:totals,backgroundColor:prodNames.map(()=>`hsl(${Math.random()*360},70%,60%)`)}]},
      options:{responsive:true}
    });
  }

  // ==================== PRODUCTOS ====================
  function renderProducts(filter=''){
    const tbl=$('productsTable'); tbl.innerHTML='';
    let filtered = products;
    if(filter) filtered = products.filter(p=>p.name.toLowerCase().includes(filter.toLowerCase())||p.code.toLowerCase().includes(filter.toLowerCase()));
    filtered.forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${p.code}</td><td>${p.name}</td><td>${p.stock}</td><td>${p.price.toFixed(2)}</td>
      <td>
        <button class="btn btn-sm btn-pastel" onclick="updateProduct('${p.id}')">Actualizar</button>
        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">Eliminar</button>
      </td>`;
      tbl.appendChild(tr);
    });
    $('newProductCode').value='P'+String(products.length+1).padStart(3,'0');
  }

  document.getElementById('addProductBtn').addEventListener('click',()=>{
    const name=$('newProductName').value.trim();
    const stock=parseInt($('newProductStock').value)||0;
    const price=parseFloat($('newProductPrice').value)||0;
    if(!name) return alert('Nombre requerido');
    products.push({id:'p'+Date.now(),code:'P'+String(products.length+1).padStart(3,'0'),name,stock,price});
    $('newProductName').value=''; $('newProductStock').value=''; $('newProductPrice').value='';
    saveAll(); renderProducts(); renderCounts();
  });

  window.updateProduct=id=>{
    const p=products.find(p=>p.id===id); if(!p) return;
    const name=prompt('Nombre',p.name); if(name)p.name=name;
    const stock=parseInt(prompt('Stock',p.stock)); if(!isNaN(stock))p.stock=stock;
    const price=parseFloat(prompt('Precio',p.price)); if(!isNaN(price))p.price=price;
    saveAll(); renderProducts(); renderCounts();
  };
  window.deleteProduct=id=>{products=products.filter(p=>p.id!==id); saveAll(); renderProducts(); renderCounts();}

  // ==================== CLIENTES ====================
  function renderClients(filter=''){
    const tbl=$('clientsTable'); tbl.innerHTML='';
    let filtered = clients;
    if(filter) filtered = clients.filter(c=>c.name.toLowerCase().includes(filter.toLowerCase())||c.code.toLowerCase().includes(filter.toLowerCase()));
    filtered.forEach(c=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${c.code}</td><td>${c.name}</td><td>${c.doc}</td><td>${c.phone}</td><td>${c.email}</td>
      <td>
        <button class="btn btn-sm btn-pastel" onclick="updateClient('${c.id}')">Actualizar</button>
        <button class="btn btn-sm btn-danger" onclick="deleteClient('${c.id}')">Eliminar</button>
      </td>`;
      tbl.appendChild(tr);
    });
    $('newClientCode').value='C'+String(clients.length+1).padStart(3,'0');
  }

  document.getElementById('addClientBtn').addEventListener('click',()=>{
    const name=$('newClientName').value.trim();
    const doc=$('newClientDoc').value.trim()||'---';
    const phone=$('newClientPhone').value.trim()||'---';
    const email=$('newClientEmail').value.trim()||'---';
    if(!name) return alert('Nombre requerido');
    clients.push({id:'c'+Date.now(),code:'C'+String(clients.length+1).padStart(3,'0'),name,doc,phone,email});
    $('newClientName').value=''; $('newClientDoc').value=''; $('newClientPhone').value=''; $('newClientEmail').value='';
    saveAll(); renderClients(); renderCounts();
  });

  window.updateClient=id=>{
    const c=clients.find(c=>c.id===id); if(!c) return;
    const name=prompt('Nombre',c.name); if(name)c.name=name;
    const doc=prompt('Documento',c.doc); if(doc)c.doc=doc;
    const phone=prompt('Tel√©fono',c.phone); if(phone)c.phone=phone;
    const email=prompt('Email',c.email); if(email)c.email=email;
    saveAll(); renderClients();
  };
  window.deleteClient=id=>{clients=clients.filter(c=>c.id!==id); saveAll(); renderClients(); renderCounts();}

  // ==================== Live Search ====================
  $('searchProduct').addEventListener('input',e=>renderProducts(e.target.value));
  $('searchClient').addEventListener('input',e=>renderClients(e.target.value));

  // ==================== VENTAS ====================
  function renderCart(){
    const tbody=$('cartTbody'); tbody.innerHTML='';
    let total=0;
    cart.forEach((item,index)=>{
      const subtotal=item.price*item.qty; total+=subtotal;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${item.name}</td><td>${item.qty}</td><td>${item.price.toFixed(2)}</td><td>${subtotal.toFixed(2)}</td><td>${item.client}</td>
      <td><button class="btn btn-sm btn-danger" onclick="removeCart(${index})">X</button></td>`;
      tbody.appendChild(tr);
    });
    $('cartTotal').textContent=total.toFixed(2);
  }

  function removeCart(index){cart.splice(index,1); saveAll(); renderCart(); renderProducts(); renderCounts(); renderSalesChart();}

  // --- Autocompletado Productos ---
  const searchSale = $('searchSale');
  const autoProduct = $('autocompleteProduct');
  searchSale.addEventListener('input',()=>{
    const val = searchSale.value.toLowerCase();
    autoProduct.innerHTML='';
    if(!val) return;
    const matches = products.filter(p => p.name.toLowerCase().includes(val));
    matches.forEach(p=>{
      const div = document.createElement('div');
      div.className='autocomplete-item';
      div.textContent=p.name;
      div.addEventListener('click',()=>{
        searchSale.value=p.name;
        autoProduct.innerHTML='';
      });
      autoProduct.appendChild(div);
    });
  });

  // --- Autocompletado Clientes ---
  const clientSale = $('clientSale');
  const autoClient = $('autocompleteClient');
  clientSale.addEventListener('input',()=>{
    const val = clientSale.value.toLowerCase();
    autoClient.innerHTML='';
    if(!val) return;
    const matches = clients.filter(c => c.name.toLowerCase().includes(val));
    matches.forEach(c=>{
      const div = document.createElement('div');
      div.className='autocomplete-item';
      div.textContent=c.name;
      div.addEventListener('click',()=>{
        clientSale.value=c.name;
        autoClient.innerHTML='';
      });
      autoClient.appendChild(div);
    });
  });

  // Cerrar listas al clic fuera
  document.addEventListener('click',e=>{
    if(e.target!==searchSale) autoProduct.innerHTML='';
    if(e.target!==clientSale) autoClient.innerHTML='';
  });

  // --- A√±adir Venta ---
  $('btnAddSale').addEventListener('click',()=>{
    const search = $('searchSale').value.trim().toLowerCase();
    const qty = parseInt($('qtySale').value)||1;
    let clientName = $('clientSale').value.trim();
    if(!search || !clientName) return alert('Producto y cliente requeridos');

    const prod = products.find(p => p.name.toLowerCase().includes(search));
    if(!prod) return alert('Producto no encontrado');
    if(prod.stock < qty) return alert('Stock insuficiente');

    // Cliente nuevo autom√°tico
    let client = clients.find(c => c.name.toLowerCase() === clientName.toLowerCase());
    if(!client){
      client = {id:'c'+Date.now(),code:'C'+String(clients.length+1).padStart(3,'0'),name: clientName,doc:'---',phone:'---',email:'---'};
      clients.push(client); saveAll(); renderClients();
    }

    cart.push({id:prod.id,name:prod.name,price:prod.price,qty,client:client.name});
    prod.stock -= qty;
    saveAll();
    renderCart(); renderProducts(); renderCounts(); renderSalesChart();
    $('searchSale').value=''; $('qtySale').value='1'; $('clientSale').value='';
  });

  // --- Completar Venta ---
  $('completeSale').addEventListener('click',()=>{
    if(cart.length===0) return alert('Carrito vac√≠o');
    cart.forEach(item=>{sales.push(item);});
    cart=[]; saveAll();
    renderCart(); renderSalesReport(); renderProducts(); renderCounts(); renderSalesChart();
  });

  // --- Reporte de Ventas ---
  function renderSalesReport(){
    const tbody=$('salesReport'); tbody.innerHTML='';
    let total=0;
    sales.forEach((s,index)=>{
      const tr=document.createElement('tr');
      const subtotal=s.price*s.qty; total+=subtotal;
      tr.innerHTML=`<td>${s.client}</td><td>${s.name}</td><td>${s.qty}</td><td>${subtotal.toFixed(2)}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteSale(${index})">Eliminar</button></td>`;
      tbody.appendChild(tr);
    });
    $('totalSold').textContent=total.toFixed(2);
  }
  window.deleteSale=index=>{
    sales.splice(index,1); saveAll(); renderSalesReport(); renderCounts(); renderProducts(); renderSalesChart();
  };

  // ==================== Export ====================
  $('exportExcel').addEventListener('click',()=>{
    const ws=XLSX.utils.json_to_sheet(sales.map(s=>({Cliente:s.client,Producto:s.name,Cantidad:s.qty,Total:(s.price*s.qty).toFixed(2)})));
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Ventas'); XLSX.writeFile(wb,'ventas.xlsx');
  });
  $('exportPDF').addEventListener('click',()=>{
    const { jsPDF } = window.jspdf; const doc=new jsPDF();
    let y=10; doc.text('Reporte de Ventas',10,y); y+=10;
    sales.forEach(s=>{doc.text(`${s.client} - ${s.name} - ${s.qty} - S/${(s.price*s.qty).toFixed(2)}`,10,y); y+=7;});
    doc.save('ventas.pdf');
  });

});
</script>
</body>
</html>
